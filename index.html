<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Peter Note 1.0</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <style>
    :root{
      --bg:#0f1115; --card:#121722; --line:#222;
      --text:#e9eef7; --muted:#b8c4da;
      --red:#ff5c5c; --green:#39d98a;
      --soft:#151a22; --ring:#2a2f3a;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{
      padding:16px 18px;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:rgba(15,17,21,.92);backdrop-filter:blur(8px);
      display:flex;gap:12px;align-items:center
    }
    header img{width:30px;height:30px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted);margin-top:4px}
    main{padding:18px;max-width:820px;margin:0 auto}

    .tabs{display:flex;gap:10px;margin:12px 0}
    .tab{
      border-radius:999px;padding:9px 14px;border:1px solid var(--ring);
      background:transparent;color:var(--muted);transition:.15s ease;
    }
    .tab.active{background:var(--soft);color:var(--text);box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}

    input,button,textarea{
      border-radius:12px;border:1px solid var(--ring);background:var(--soft);color:var(--text);
      padding:11px 12px;font-size:14px;outline:none
    }
    input{flex:1;min-width:240px}
    input:focus, textarea:focus{border-color:#3a4252; box-shadow:0 0 0 3px rgba(58,66,82,.25)}
    button{cursor:pointer}
    .ghost{background:transparent}
    .danger{border-color:#5a2a2a;color:#ffb4b4}
    .ok{border-color:#1f4a35;color:#b9ffe0}

    ul{list-style:none;padding:0;margin:10px 0}
    li{
      display:flex;gap:12px;align-items:flex-start;
      padding:13px 13px;border:1px solid var(--line);border-radius:14px;margin-bottom:10px;background:var(--card);
      box-shadow:0 14px 30px rgba(0,0,0,.22);
      transition:transform .08s ease, border-color .15s ease;
    }
    li:active{transform:scale(.99)}
    .badge{width:11px;height:11px;border-radius:50%;margin-top:7px;flex:0 0 auto}
    .badge.open{background:var(--red);box-shadow:0 0 0 4px rgba(255,92,92,.12)}
    .badge.done{background:var(--green);box-shadow:0 0 0 4px rgba(57,217,138,.12)}
    .title{flex:1;min-width:0}
    .title strong{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title .sub{color:var(--muted);font-size:12px;margin-top:3px}
    .pill{font-size:12px;padding:3px 9px;border-radius:999px;border:1px solid var(--ring);color:var(--muted)}

    dialog{
      width:min(760px, 94vw); border:1px solid var(--ring); border-radius:16px; background:#0f141d; color:var(--text);
      padding:0; box-shadow:0 25px 80px rgba(0,0,0,.55)
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlgHead{padding:14px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
    .dlgHead .sp{flex:1;min-width:0}
    .dlgBody{padding:14px}
    textarea{width:100%;min-height:180px;resize:vertical}
    .dlgFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .confirmBox{
      padding:12px;border:1px solid var(--ring);background:rgba(21,26,34,.65);border-radius:12px;margin-top:12px
    }
    .confirmRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .confirmRow input{flex:0 0 220px; min-width:220px}

    /* images */
    .imgBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0 10px}
    .gallery{display:flex;gap:10px;flex-wrap:wrap}
    .thumb{
      width:88px;height:88px;border-radius:14px;border:1px solid var(--ring);
      background:#0b0e13; overflow:hidden; position:relative;
      box-shadow:0 10px 24px rgba(0,0,0,.28)
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb button{
      position:absolute;top:6px;right:6px;
      padding:6px 8px;border-radius:10px;border:1px solid #5a2a2a;background:rgba(15,17,21,.75);color:#ffb4b4
    }
    .imgInfo{font-size:12px;color:var(--muted)}
    .fullImg{max-width:92vw;max-height:82vh;display:block;margin:0 auto}
  </style>
</head>
<body>
<header>
  <img src="icon-192.png" alt="Icon">
  <div>
    <h1>Peter Note 1.0</h1>
    <div class="small" id="todayLine"></div>
  </div>
</header>

<main>
  <div class="tabs">
    <button id="tabTodo" class="tab active">To-Do</button>
    <button id="tabArchive" class="tab">Archiv</button>
  </div>

  <div class="row">
    <input id="search" placeholder="Suchen in Aufgaben, Notizen & Bildern‚Ä¶" autocomplete="off" />
    <button id="clearSearch" class="ghost" title="Suche l√∂schen">√ó</button>
  </div>

  <div class="row" id="addRow">
    <input id="text" placeholder="Neue Aufgabe‚Ä¶ z.B. VPI Schulung planen" autocomplete="off" />
    <button id="add">Hinzuf√ºgen</button>
  </div>

  <ul id="list"></ul>

  <div class="row">
    <button id="exportBtn">Backup exportieren</button>
    <button id="importBtn">Backup importieren</button>
    <input id="importFile" type="file" accept="application/json" hidden />
  </div>
  <div class="small">Tippen auf Eintrag √∂ffnet Details. Erledigen/L√∂schen nur dort (mit Best√§tigung).</div>
</main>

<!-- Main dialog -->
<dialog id="dlg">
  <div class="dlgHead">
    <span id="dlgStatus" class="pill"></span>
    <div class="sp">
      <div id="dlgTitle" style="font-weight:750;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
      <div class="small" id="dlgCreated"></div>
    </div>
    <button id="dlgClose" class="ghost">Schliessen</button>
  </div>

  <div class="dlgBody">
    <div class="imgBar">
      <button id="addPhoto" class="ghost">üì∑ Foto</button>
      <button id="addImage" class="ghost">üñº Bild</button>
      <span class="imgInfo" id="imgInfo"></span>

      <!-- hidden inputs -->
      <input id="pickImage" type="file" accept="image/*" hidden />
      <input id="takePhoto" type="file" accept="image/*" capture="environment" hidden />
    </div>

    <div class="gallery" id="gallery"></div>

    <label class="small" style="display:block;margin-top:14px">Notizen (freier Text)</label>
    <textarea id="dlgNotes" placeholder="Hier kannst du alles reinschreiben‚Ä¶"></textarea>
    <div class="hint">‚ÄûNotiz-Zeile hinzuf√ºgen‚Äú setzt automatisch Datum+Uhrzeit davor.</div>

    <div class="confirmBox">
      <div class="small" style="margin:0 0 6px 0">Sichere Aktionen</div>
      <div class="small" style="margin:0">
        ‚Ä¢ Erledigen/Zur√ºckholen fragt immer nach Best√§tigung.<br>
        ‚Ä¢ L√∂schen ist endg√ºltig: tippe zur Best√§tigung <b>L√ñSCHEN</b>.
      </div>
      <div class="confirmRow">
        <input id="deleteConfirm" placeholder='Tippe: L√ñSCHEN' autocomplete="off" />
        <button id="toggleDone" class="ok"></button>
        <button id="deleteTask" class="danger">Endg√ºltig l√∂schen</button>
      </div>
    </div>
  </div>

  <div class="dlgFoot">
    <button id="appendLine" class="ghost">Notiz-Zeile hinzuf√ºgen</button>
    <button id="saveTask">Speichern</button>
  </div>
</dialog>

<!-- Image preview dialog -->
<dialog id="imgDlg">
  <div class="dlgHead">
    <div class="sp"><div style="font-weight:700">Bildvorschau</div></div>
    <button id="imgClose" class="ghost">Schliessen</button>
  </div>
  <div class="dlgBody">
    <img id="imgPreview" class="fullImg" alt="Vorschau">
  </div>
</dialog>

<script>
const LS_KEY = "peter_note_v2"; // neue Version, damit wir sauber erweitern

const pad2 = n => String(n).padStart(2,"0");
function fmtDate(d=new Date()){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${String(d.getFullYear()).slice(-2)}`; }
function fmtDateTime(d=new Date()){ return `${fmtDate(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
document.getElementById("todayLine").textContent = "Heute: " + fmtDate(new Date());

function load(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || { items:[], view:"todo", q:"" }; }
  catch { return { items:[], view:"todo", q:"" }; }
}
function save(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }
function sortItems(items){ return [...items].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)); }

function normalizeItem(it){
  it.images = Array.isArray(it.images) ? it.images : [];
  it.notes = it.notes || "";
  it.doneAt = it.doneAt || null;
  it.createdLabel = it.createdLabel || fmtDate(new Date(it.createdAt || Date.now()));
  return it;
}

function addTask(text){
  const db = load();
  const now = new Date();
  db.items.unshift(normalizeItem({
    id: crypto.randomUUID(),
    titleRaw: text.trim(),
    createdAt: now.toISOString(),
    createdLabel: fmtDate(now),
    done: false,
    doneAt: null,
    notes: "",
    images: []
  }));
  save(db);
}

function updateTask(id, patch){
  const db = load();
  const it = db.items.find(x => x.id === id);
  if(!it) return;
  Object.assign(it, patch);
  normalizeItem(it);
  save(db);
}

function removeTask(id){
  const db = load();
  db.items = db.items.filter(x => x.id !== id);
  save(db);
}

function setView(v){ const db = load(); db.view = v; save(db); }
function setQuery(q){ const db = load(); db.q = q; save(db); }

function matchesQuery(it, q){
  if(!q) return true;
  q = q.toLowerCase();
  const imgNames = (it.images||[]).map(x => x.name || "").join(" ");
  const hay = `${it.createdLabel} ${it.titleRaw}\n${it.notes||""}\n${imgNames}`.toLowerCase();
  return hay.includes(q);
}

function filtered(db){
  const isArchive = db.view === "archive";
  db.items = db.items.map(normalizeItem);
  let items = db.items.filter(x => isArchive ? x.done : !x.done);
  items = items.filter(it => matchesQuery(it, (db.q||"").trim()));
  return sortItems(items);
}

// ---------- image helpers (resize + compress) ----------
async function fileToCompressedDataUrl(file, maxSide=1280, quality=0.8){
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });

  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;

  let nw = w, nh = h;
  const scale = Math.min(1, maxSide / Math.max(w, h));
  nw = Math.round(w * scale);
  nh = Math.round(h * scale);

  const canvas = document.createElement("canvas");
  canvas.width = nw; canvas.height = nh;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, nw, nh);
  URL.revokeObjectURL(img.src);

  // JPEG is usually smaller; keep it simple:
  return canvas.toDataURL("image/jpeg", quality);
}

function bytesApproxFromDataUrl(dataUrl){
  // base64 size approx
  const base64 = dataUrl.split(",")[1] || "";
  return Math.floor(base64.length * 0.75);
}

function formatBytes(n){
  if(n < 1024) return n + " B";
  if(n < 1024*1024) return (n/1024).toFixed(1) + " KB";
  return (n/(1024*1024)).toFixed(2) + " MB";
}

// ---------- UI ----------
const listEl = document.getElementById("list");
const dlg = document.getElementById("dlg");
const imgDlg = document.getElementById("imgDlg");
let activeId = null;

function getActiveItem(){
  const db = load();
  const it = db.items.find(x => x.id === activeId);
  if(!it) return null;
  return normalizeItem(it);
}

function openDialog(item){
  activeId = item.id;
  document.getElementById("dlgTitle").textContent = `${item.createdLabel} ${item.titleRaw}`;
  document.getElementById("dlgCreated").textContent = "Erstellt: " + fmtDateTime(new Date(item.createdAt));
  document.getElementById("dlgNotes").value = item.notes || "";
  document.getElementById("dlgStatus").textContent = item.done ? "erledigt (Archiv)" : "offen (To-Do)";
  document.getElementById("toggleDone").textContent = item.done ? "Zur√ºck zu To-Do" : "Als erledigt ins Archiv";
  document.getElementById("deleteConfirm").value = "";
  renderGallery(item);
  dlg.showModal();
}

function renderGallery(item){
  const g = document.getElementById("gallery");
  const info = document.getElementById("imgInfo");
  g.innerHTML = "";

  const imgs = item.images || [];
  let total = 0;
  imgs.forEach(x => total += bytesApproxFromDataUrl(x.dataUrl || ""));
  info.textContent = imgs.length ? `${imgs.length} Bild(er) ‚Ä¢ ca. ${formatBytes(total)}` : "Keine Bilder";

  imgs.forEach((imgObj) => {
    const d = document.createElement("div");
    d.className = "thumb";

    const im = document.createElement("img");
    im.src = imgObj.dataUrl;
    im.alt = imgObj.name || "Bild";
    im.addEventListener("click", (e) => {
      e.stopPropagation();
      document.getElementById("imgPreview").src = imgObj.dataUrl;
      imgDlg.showModal();
    });

    const del = document.createElement("button");
    del.textContent = "‚úï";
    del.title = "Bild l√∂schen";
    del.addEventListener("click", async (e) => {
      e.stopPropagation();
      if(!confirm("Dieses Bild wirklich l√∂schen?")) return;
      const it = getActiveItem();
      if(!it) return;
      it.images = (it.images || []).filter(x => x.id !== imgObj.id);
      updateTask(it.id, { images: it.images });
      renderGallery(getActiveItem());
    });

    d.appendChild(im);
    d.appendChild(del);
    g.appendChild(d);
  });
}

function render(){
  const db = load();
  const todoOn = db.view !== "archive";
  document.getElementById("tabTodo").classList.toggle("active", todoOn);
  document.getElementById("tabArchive").classList.toggle("active", !todoOn);
  document.getElementById("addRow").style.display = todoOn ? "flex" : "none";

  const s = document.getElementById("search");
  if(s.value !== (db.q||"")) s.value = db.q || "";

  listEl.innerHTML = "";
  const items = filtered(db);

  items.forEach(it => {
    const li = document.createElement("li");
    const badge = document.createElement("div");
    badge.className = "badge " + (it.done ? "done" : "open");

    const title = document.createElement("div");
    title.className = "title";
    const main = document.createElement("strong");
    main.textContent = `${it.createdLabel} ${it.titleRaw}`;

    const sub = document.createElement("div");
    sub.className = "sub";
    const noteLines = (it.notes || "").trim() ? it.notes.trim().split("\n").length : 0;
    const imgCount = (it.images || []).length;
    const statusLine = it.done ? ("Erledigt: " + (it.doneAt ? fmtDateTime(new Date(it.doneAt)) : "‚Äî")) : "Offen";
    sub.textContent = `${statusLine} ‚Ä¢ ${noteLines ? noteLines+" Notizzeile(n)" : "keine Notizen"} ‚Ä¢ ${imgCount ? imgCount+" Bild(er)" : "keine Bilder"}`;

    title.appendChild(main);
    title.appendChild(sub);

    li.appendChild(badge);
    li.appendChild(title);
    li.addEventListener("click", () => openDialog(it));
    listEl.appendChild(li);
  });
}

// Tabs
document.getElementById("tabTodo").addEventListener("click", ()=>{ setView("todo"); render(); });
document.getElementById("tabArchive").addEventListener("click", ()=>{ setView("archive"); render(); });

// Add
document.getElementById("add").addEventListener("click", () => {
  const text = document.getElementById("text");
  if(!text.value.trim()) return;
  addTask(text.value);
  text.value = "";
  render();
});
document.getElementById("text").addEventListener("keydown", (e) => {
  if(e.key === "Enter") document.getElementById("add").click();
});

// Search
document.getElementById("search").addEventListener("input", (e)=>{ setQuery(e.target.value); render(); });
document.getElementById("clearSearch").addEventListener("click", ()=>{ setQuery(""); render(); });

// Dialog close
document.getElementById("dlgClose").addEventListener("click", () => dlg.close());
document.getElementById("imgClose").addEventListener("click", () => imgDlg.close());

// Save notes
document.getElementById("saveTask").addEventListener("click", () => {
  if(!activeId) return;
  updateTask(activeId, { notes: document.getElementById("dlgNotes").value });
  dlg.close(); render();
});

document.getElementById("appendLine").addEventListener("click", () => {
  const ta = document.getElementById("dlgNotes");
  const prefix = fmtDateTime(new Date()) + " ";
  if(ta.value && !ta.value.endsWith("\n")) ta.value += "\n";
  ta.value += prefix;
  ta.focus();
  ta.selectionStart = ta.selectionEnd = ta.value.length;
});

// Done / undo
document.getElementById("toggleDone").addEventListener("click", () => {
  if(!activeId) return;
  const db = load();
  const it = db.items.find(x => x.id === activeId);
  if(!it) return;
  normalizeItem(it);
  it.notes = document.getElementById("dlgNotes").value;

  const goingDone = !it.done;
  const msg = goingDone
    ? "Diese Aufgabe als ERLEDIGT markieren und ins Archiv verschieben?"
    : "Diese Aufgabe zur√ºck in To-Do holen (wieder OFFEN)?";
  if(!confirm(msg)) return;

  if(goingDone){ it.done = true; it.doneAt = new Date().toISOString(); }
  else { it.done = false; it.doneAt = null; }

  save(db);
  dlg.close(); render();
});

// Delete (final)
document.getElementById("deleteTask").addEventListener("click", () => {
  if(!activeId) return;
  const typed = (document.getElementById("deleteConfirm").value || "").trim().toUpperCase();
  if(typed !== "L√ñSCHEN" && typed !== "LOESCHEN"){
    alert('Zum endg√ºltigen L√∂schen bitte "L√ñSCHEN" (oder "LOESCHEN") eintippen.');
    return;
  }
  if(!confirm("Wirklich ENDG√úLTIG l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden.")) return;
  removeTask(activeId);
  activeId = null;
  dlg.close(); render();
});

// Image add buttons
document.getElementById("addImage").addEventListener("click", () => document.getElementById("pickImage").click());
document.getElementById("addPhoto").addEventListener("click", () => document.getElementById("takePhoto").click());

async function handlePickedFiles(fileList){
  const files = Array.from(fileList || []).filter(f => (f.type||"").startsWith("image/"));
  if(!files.length) return;

  const it = getActiveItem();
  if(!it) return;

  for(const f of files){
    const dataUrl = await fileToCompressedDataUrl(f, 1280, 0.8);
    it.images.push({
      id: crypto.randomUUID(),
      name: f.name || "Foto",
      addedAt: new Date().toISOString(),
      dataUrl
    });
  }
  updateTask(it.id, { images: it.images, notes: document.getElementById("dlgNotes").value });
  renderGallery(getActiveItem());
  render();
}

document.getElementById("pickImage").addEventListener("change", (e) => handlePickedFiles(e.target.files));
document.getElementById("takePhoto").addEventListener("change", (e) => handlePickedFiles(e.target.files));

// Backup export/import
document.getElementById("exportBtn").addEventListener("click", () => {
  const db = load();
  const payload = { exportedAt:new Date().toISOString(), app:"peter_note", version:2, data:db };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `peter_note_backup_${fmtDate(new Date()).replaceAll(".","-")}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").value = "";
  document.getElementById("importFile").click();
});
document.getElementById("importFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  const txt = await file.text();
  let parsed;
  try { parsed = JSON.parse(txt); } catch { alert("Import fehlgeschlagen: ung√ºltiges JSON."); return; }

  const db = parsed?.data?.items ? parsed.data : (parsed?.items ? parsed : null);
  if(!db || !Array.isArray(db.items)){ alert("Import fehlgeschlagen: Struktur nicht erkannt."); return; }

  db.view = db.view || "todo";
  db.q = db.q || "";
  db.items = db.items.map(it => normalizeItem({
    id: it.id || crypto.randomUUID(),
    titleRaw: it.titleRaw || it.title || "",
    createdAt: it.createdAt || new Date().toISOString(),
    createdLabel: it.createdLabel || fmtDate(new Date(it.createdAt || Date.now())),
    done: !!it.done,
    doneAt: it.doneAt || null,
    notes: it.notes || "",
    images: Array.isArray(it.images) ? it.images : []
  }));

  localStorage.setItem(LS_KEY, JSON.stringify(db));
  render();
  alert("Import ok.");
});

// service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
render();
</script>
</body>
</html>
