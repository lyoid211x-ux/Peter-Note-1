<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Peter Note 1.0</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <style>
    :root{
      --bg:#0f1115; --card:#121722; --line:#222;
      --text:#e9eef7; --muted:#b8c4da;
      --red:#ff5c5c; --green:#39d98a;
      --soft:#151a22; --ring:#2a2f3a;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
    header{
      padding:16px 18px;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:rgba(15,17,21,.92);backdrop-filter:blur(8px);
      display:flex;gap:12px;align-items:center
    }
    header img{width:30px;height:30px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted);margin-top:4px}
    main{padding:18px;max-width:820px;margin:0 auto}

    .tabs{display:flex;gap:10px;margin:12px 0}
    .tab{
      border-radius:999px;padding:9px 14px;border:1px solid var(--ring);
      background:transparent;color:var(--muted);transition:.15s ease;
    }
    .tab.active{background:var(--soft);color:var(--text);box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;margin:12px 0;flex-wrap:wrap}

    input,button,textarea{
      border-radius:12px;border:1px solid var(--ring);background:var(--soft);color:var(--text);
      padding:11px 12px;font-size:14px;outline:none
    }
    input{flex:1;min-width:240px}
    input:focus, textarea:focus{border-color:#3a4252; box-shadow:0 0 0 3px rgba(58,66,82,.25)}
    button{cursor:pointer}
    .ghost{background:transparent}
    .danger{border-color:#5a2a2a;color:#ffb4b4}
    .ok{border-color:#1f4a35;color:#b9ffe0}

    ul{list-style:none;padding:0;margin:10px 0}
    li{
      display:flex;gap:12px;align-items:flex-start;
      padding:13px 13px;border:1px solid var(--line);border-radius:14px;margin-bottom:10px;background:var(--card);
      box-shadow:0 14px 30px rgba(0,0,0,.22);
      transition:transform .08s ease, border-color .15s ease;
    }
    li:active{transform:scale(.99)}
    .badge{width:11px;height:11px;border-radius:50%;margin-top:7px;flex:0 0 auto}
    .badge.open{background:var(--red);box-shadow:0 0 0 4px rgba(255,92,92,.12)}
    .badge.done{background:var(--green);box-shadow:0 0 0 4px rgba(57,217,138,.12)}
    .title{flex:1;min-width:0}
    .title strong{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title .sub{color:var(--muted);font-size:12px;margin-top:3px}

    .pill{font-size:12px;padding:3px 9px;border-radius:999px;border:1px solid var(--ring);color:var(--muted)}

    dialog{
      width:min(760px, 94vw); border:1px solid var(--ring); border-radius:16px; background:#0f141d; color:var(--text);
      padding:0; box-shadow:0 25px 80px rgba(0,0,0,.55)
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlgHead{padding:14px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
    .dlgHead .sp{flex:1;min-width:0}
    .dlgBody{padding:14px}
    textarea{width:100%;min-height:200px;resize:vertical}
    .dlgFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .confirmBox{
      padding:12px;border:1px solid var(--ring);background:rgba(21,26,34,.65);border-radius:12px;margin-top:10px
    }
    .confirmRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    .confirmRow input{flex:0 0 220px; min-width:220px}
  </style>
</head>
<body>
<header>
  <img src="icon-192.png" alt="Icon">
  <div>
    <h1>Peter Note 1.0</h1>
    <div class="small" id="todayLine"></div>
  </div>
</header>

<main>
  <div class="tabs">
    <button id="tabTodo" class="tab active">To-Do</button>
    <button id="tabArchive" class="tab">Archiv</button>
  </div>

  <div class="row">
    <input id="search" placeholder="Suchen in Aufgaben & Notizen…" autocomplete="off" />
    <button id="clearSearch" class="ghost" title="Suche löschen">×</button>
  </div>

  <div class="row" id="addRow">
    <input id="text" placeholder="Neue Aufgabe… z.B. VPI Schulung planen" autocomplete="off" />
    <button id="add">Hinzufügen</button>
  </div>

  <ul id="list"></ul>

  <div class="row">
    <button id="exportBtn">Backup exportieren</button>
    <button id="importBtn">Backup importieren</button>
    <input id="importFile" type="file" accept="application/json" hidden />
  </div>
  <div class="small">Tippen auf Eintrag öffnet Details. Erledigen/Löschen nur dort (mit Bestätigung).</div>
</main>

<dialog id="dlg">
  <div class="dlgHead">
    <span id="dlgStatus" class="pill"></span>
    <div class="sp">
      <div id="dlgTitle" style="font-weight:750;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
      <div class="small" id="dlgCreated"></div>
    </div>
    <button id="dlgClose" class="ghost">Schliessen</button>
  </div>

  <div class="dlgBody">
    <label class="small">Notizen (freier Text)</label>
    <textarea id="dlgNotes" placeholder="Hier kannst du alles reinschreiben…"></textarea>
    <div class="hint">„Notiz-Zeile hinzufügen“ setzt automatisch Datum+Uhrzeit davor.</div>

    <div class="confirmBox">
      <div class="small" style="margin:0 0 6px 0">Sichere Aktionen</div>
      <div class="small" style="margin:0">
        • Erledigen/Zurückholen fragt immer nach Bestätigung.<br>
        • Löschen ist endgültig: tippe zur Bestätigung <b>LÖSCHEN</b>.
      </div>
      <div class="confirmRow">
        <input id="deleteConfirm" placeholder='Tippe: LÖSCHEN' autocomplete="off" />
        <button id="toggleDone" class="ok"></button>
        <button id="deleteTask" class="danger">Endgültig löschen</button>
      </div>
    </div>
  </div>

  <div class="dlgFoot">
    <button id="appendLine" class="ghost">Notiz-Zeile hinzufügen</button>
    <button id="saveTask">Speichern</button>
  </div>
</dialog>

<script>
const LS_KEY = "peter_note_v1";
const pad2 = n => String(n).padStart(2,"0");
function fmtDate(d=new Date()){ return `${pad2(d.getDate())}.${pad2(d.getMonth()+1)}.${String(d.getFullYear()).slice(-2)}`; }
function fmtDateTime(d=new Date()){ return `${fmtDate(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
document.getElementById("todayLine").textContent = "Heute: " + fmtDate(new Date());

function load(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || { items:[], view:"todo", q:"" }; }
  catch { return { items:[], view:"todo", q:"" }; }
}
function save(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }
function sortItems(items){ return [...items].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)); }

function addTask(text){
  const db = load();
  const now = new Date();
  db.items.unshift({
    id: crypto.randomUUID(),
    titleRaw: text.trim(),
    createdAt: now.toISOString(),
    createdLabel: fmtDate(now),
    done: false,
    doneAt: null,
    notes: ""
  });
  save(db);
}
function updateTask(id, confirmPatch){
  const db = load();
  const it = db.items.find(x => x.id === id);
  if(!it) return;
  Object.assign(it, confirmPatch);
  save(db);
}
function removeTask(id){
  const db = load();
  db.items = db.items.filter(x => x.id !== id);
  save(db);
}
function setView(v){
  const db = load(); db.view = v; save(db);
}
function setQuery(q){
  const db = load(); db.q = q; save(db);
}
function matchesQuery(it, q){
  if(!q) return true;
  q = q.toLowerCase();
  const hay = `${it.createdLabel} ${it.titleRaw}\n${it.notes||""}`.toLowerCase();
  return hay.includes(q);
}
function filtered(db){
  const isArchive = db.view === "archive";
  let items = db.items.filter(x => isArchive ? x.done : !x.done);
  items = items.filter(it => matchesQuery(it, (db.q||"").trim()));
  return sortItems(items);
}

// UI
const listEl = document.getElementById("list");
const dlg = document.getElementById("dlg");
let activeId = null;

function openDialog(item){
  activeId = item.id;
  document.getElementById("dlgTitle").textContent = `${item.createdLabel} ${item.titleRaw}`;
  document.getElementById("dlgCreated").textContent = "Erstellt: " + fmtDateTime(new Date(item.createdAt));
  document.getElementById("dlgNotes").value = item.notes || "";
  document.getElementById("dlgStatus").textContent = item.done ? "erledigt (Archiv)" : "offen (To-Do)";
  document.getElementById("toggleDone").textContent = item.done ? "Zurück zu To-Do" : "Als erledigt ins Archiv";
  document.getElementById("deleteConfirm").value = "";
  dlg.showModal();
}

function render(){
  const db = load();
  const todoOn = db.view !== "archive";
  document.getElementById("tabTodo").classList.toggle("active", todoOn);
  document.getElementById("tabArchive").classList.toggle("active", !todoOn);
  document.getElementById("addRow").style.display = todoOn ? "flex" : "none";

  const s = document.getElementById("search");
  if(s.value !== (db.q||"")) s.value = db.q || "";

  listEl.innerHTML = "";
  const items = filtered(db);

  items.forEach(it => {
    const li = document.createElement("li");

    const badge = document.createElement("div");
    badge.className = "badge " + (it.done ? "done" : "open");

    const title = document.createElement("div");
    title.className = "title";

    const main = document.createElement("strong");
    main.textContent = `${it.createdLabel} ${it.titleRaw}`;

    const sub = document.createElement("div");
    sub.className = "sub";
    const noteLines = (it.notes || "").trim() ? it.notes.trim().split("\n").length : 0;
    const statusLine = it.done
      ? ("Erledigt: " + (it.doneAt ? fmtDateTime(new Date(it.doneAt)) : "—"))
      : "Offen";
    sub.textContent = `${statusLine} • ${noteLines ? noteLines+" Notizzeile(n)" : "keine Notizen"}`;

    title.appendChild(main);
    title.appendChild(sub);

    li.appendChild(badge);
    li.appendChild(title);
    li.addEventListener("click", () => openDialog(it));

    listEl.appendChild(li);
  });
}

// Tabs
document.getElementById("tabTodo").addEventListener("click", ()=>{ setView("todo"); render(); });
document.getElementById("tabArchive").addEventListener("click", ()=>{ setView("archive"); render(); });

// Add
document.getElementById("add").addEventListener("click", () => {
  const text = document.getElementById("text");
  if(!text.value.trim()) return;
  addTask(text.value);
  text.value = "";
  render();
});
document.getElementById("text").addEventListener("keydown", (e) => {
  if(e.key === "Enter") document.getElementById("add").click();
});

// Search
document.getElementById("search").addEventListener("input", (e)=>{ setQuery(e.target.value); render(); });
document.getElementById("clearSearch").addEventListener("click", ()=>{ setQuery(""); render(); });

// Dialog actions
document.getElementById("dlgClose").addEventListener("click", () => dlg.close());

document.getElementById("saveTask").addEventListener("click", () => {
  if(!activeId) return;
  updateTask(activeId, { notes: document.getElementById("dlgNotes").value });
  dlg.close(); render();
});

document.getElementById("appendLine").addEventListener("click", () => {
  const ta = document.getElementById("dlgNotes");
  const prefix = fmtDateTime(new Date()) + " ";
  if(ta.value && !ta.value.endsWith("\n")) ta.value += "\n";
  ta.value += prefix;
  ta.focus();
  ta.selectionStart = ta.selectionEnd = ta.value.length;
});

document.getElementById("toggleDone").addEventListener("click", () => {
  if(!activeId) return;
  const db = load();
  const it = db.items.find(x => x.id === activeId);
  if(!it) return;

  // notizen vor der Aktion sichern
  it.notes = document.getElementById("dlgNotes").value;

  const goingDone = !it.done;
  const msg = goingDone
    ? "Diese Aufgabe als ERLEDIGT markieren und ins Archiv verschieben?"
    : "Diese Aufgabe zurück in To-Do holen (wieder OFFEN)?";

  if(!confirm(msg)) return;

  if(goingDone){
    it.done = true; it.doneAt = new Date().toISOString();
  } else {
    it.done = false; it.doneAt = null;
  }
  save(db);
  dlg.close();
  render();
});

document.getElementById("deleteTask").addEventListener("click", () => {
  if(!activeId) return;

  const typed = (document.getElementById("deleteConfirm").value || "").trim().toUpperCase();
  if(typed !== "LÖSCHEN" && typed !== "LOESCHEN"){
    alert('Zum endgültigen Löschen bitte "LÖSCHEN" (oder "LOESCHEN") eintippen.');
    return;
  }
  if(!confirm("Wirklich ENDGÜLTIG löschen? Das kann nicht rückgängig gemacht werden.")) return;

  removeTask(activeId);
  activeId = null;
  dlg.close();
  render();
});

// Backup export/import
document.getElementById("exportBtn").addEventListener("click", () => {
  const db = load();
  const payload = { exportedAt:new Date().toISOString(), app:"peter_note", version:1, data:db };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `peter_note_backup_${fmtDate(new Date()).replaceAll(".","-")}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").value = "";
  document.getElementById("importFile").click();
});
document.getElementById("importFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  const txt = await file.text();
  let parsed;
  try { parsed = JSON.parse(txt); } catch { alert("Import fehlgeschlagen: ungültiges JSON."); return; }

  const db = parsed?.data?.items ? parsed.data : (parsed?.items ? parsed : null);
  if(!db || !Array.isArray(db.items)){ alert("Import fehlgeschlagen: Struktur nicht erkannt."); return; }

  db.view = db.view || "todo";
  db.q = db.q || "";
  db.items = db.items.map(it => ({
    id: it.id || crypto.randomUUID(),
    titleRaw: it.titleRaw || it.title || "",
    createdAt: it.createdAt || new Date().toISOString(),
    createdLabel: it.createdLabel || fmtDate(new Date(it.createdAt || Date.now())),
    done: !!it.done,
    doneAt: it.doneAt || null,
    notes: it.notes || ""
  }));

  localStorage.setItem(LS_KEY, JSON.stringify(db));
  render();
  alert("Import ok.");
});

// service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
render();
</script>
</body>
</html>
